{% extends "layout.html" %}

{% block content %}
<div class="menu">
    <a href="{{ url_for('device_manager') }}" class="button">Device Manager</a>
    <a href="{{ url_for('broadcast_scanner') }}" class="button">Broadcast Scanner</a>
</div>

<!-- Display Selected Device Information -->
<div style="display: flex; justify-content: space-around; margin-top: 20px;">
    <div>
        <h3>Selected Device Information:</h3>
        {% if selected_device %}
            <p>Name: {{ selected_device['Name'] }}</p>
            <p>Address: {{ selected_device['Address'] }}</p>
            <p>Address Type: {{ selected_device['Address Type'] }}</p>
            <p>Connected: {{ selected_device['Connected'] }}</p>
            <p>Paired: {{ selected_device['Paired'] }}</p>
        {% else %}
            <p>No device selected.</p>
        {% endif %}
    </div>

    <div>
        <h3>Selected Broadcast Information:</h3>
        {% if selected_broadcaster %}
            <p>Name: {{ selected_broadcaster['Name'] }}</p>
            <p>Address: {{ selected_broadcaster['Address'] }}</p>
            <p>Address Type: {{ selected_broadcaster['AddressType'] }}</p>
        {% else %}
            <p>No broadcast selected.</p>
        {% endif %}
    </div>
</div>

<div style="margin-top: 20px; text-align:center;">
    <!-- Service Discovery Button -->
    <button id="serviceDiscoveryBtn" class="button">Service Discovery</button>

    <!-- Start and Stop Streaming Buttons -->
    <button id="startStreamingBtn" class="button" disabled>Start Streaming</button>
    <button id="stopStreamingBtn" class="button" disabled>Stop Streaming</button>

    <!-- Display the discovery results -->
    <div id="discoveryResults" style="margin-top: 20px;">
        <p>Broadcast Receive State Char Found: {{ brs_char_path or 'Not Found' }}</p>
        <p>Broadcast Control Point Char Found: {{ bascp_char_path or 'Not Found' }}</p>
    </div>
</div>

<!-- Stream Results -->
<div id="streamResults" style="margin-top: 20px;">
    <h3>Stream Results</h3>
    <p id="streamResultsText">No stream data received yet.</p>
</div>

<script>
    // Handle Service Discovery
    document.getElementById('serviceDiscoveryBtn').addEventListener('click', function() {
        fetch('/service_discovery', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('discoveryResults').innerHTML = `
                <p>Broadcast Receive State Char Found: ${data.brs_char_path || 'Not Found'}</p>
                <p>Broadcast Control Point Char Found: ${data.bascp_char_path || 'Not Found'}</p>
            `;
            
            if (data.brs_char_path && data.bascp_char_path) {
                document.getElementById('startStreamingBtn').disabled = false;
                document.getElementById('stopStreamingBtn').disabled = false;
            } else {
                document.getElementById('startStreamingBtn').disabled = true;
                document.getElementById('stopStreamingBtn').disabled = true;
            }
        });
    });

    // Handle Start Streaming
    document.getElementById('startStreamingBtn').addEventListener('click', function() {
        fetch('/start_streaming', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            console.log('Streaming Started:', data.result);
            fetchLastBroadcastState();
        });
    });

    // Handle Stop Streaming
    document.getElementById('stopStreamingBtn').addEventListener('click', function() {
        fetch('/stop_streaming', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            console.log('Streaming Stopped:', data.result);
            fetchLastBroadcastState();
        });
    });

    // Fetch the last broadcast state and update the stream results
    function fetchLastBroadcastState() {
        fetch('/get_last_broadcast_state')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('streamResultsText').textContent = data.error;
            } else {
                let streamResultsHtml = `
                    Data: ${data.data_hex}
                    Source_ID: ${data.Source_ID}
                    Source_Address_Type: ${data.Source_Address_Type}
                    Source_Address: ${data.Source_Address}
                    Source_Adv_SID: ${data.Source_Adv_SID}
                    Broadcast_ID: ${data.Broadcast_ID}
                    PA_Sync_State: ${data.PA_Sync_State_Description}
                    BIG_Encryption: ${data.BIG_Encryption_Description}
                    Num_Subgroups: ${data.Num_Subgroups}
                `;

                // Loop through subgroups and append their info
                data.subgroups.forEach((subgroup, index) => {
                    streamResultsHtml += `
                        Subgroup #${index}:
                        BIS_Sync_State: ${subgroup.BIS_Sync_State} (${subgroup.BIS_Sync_State_Description})
                    `;
                    if (subgroup.Metadata) {
                        streamResultsHtml += ` Metadata: ${subgroup.Metadata}`;
                    }
                });

                document.getElementById('streamResultsText').textContent = streamResultsHtml;
            }
        });
    }
</script>
{% endblock %}
